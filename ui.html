<link rel="stylesheet" href="http://127.0.0.1:5500/style.css" />
<link
  rel="stylesheet"
  href="https://static.figma.com/api/figma-extension-api-0.0.1.css"
/>
<div id="main">
  <div id="contextMenu" class="context-menu" style="display: none">
    <ul>
      <li><a id="settings" href="#">Settings</a></li>
      <li><a href="#">Reset</a></li>
      <li><a href="#">Element-3</a></li>
      <li><a href="#">Element-4</a></li>
      <li><a href="#">Element-5</a></li>
      <li><a href="#">Element-6</a></li>
      <li><a href="#">Element-7</a></li>
    </ul>
  </div>
  <div id="datesettings" class="datesettings" style="display: none">
    <h4>Date Settings</h4>
    Date Format
    <select name="format" id="format">
      <option value="format1">04/01/2022</option>
      <option value="format2">01.04.2022</option>
    </select>
    <div style="text-align: center; margin: 10px">
      <button id="apply">Apply</button>
    </div>
  </div>

  <h2>Magic Contento</h2>
  <!--
<p>Count: <input id="count" value="5" /></p>
-->
  <div style="margin: 5px">
    <button id="namemale">Male Name</button>
  </div>
  <div style="margin: 5px">
    <button id="namefemale">Female Name</button>
  </div>
  <div style="margin: 5px">
    <button id="date">Date</button>
  </div>
  <div style="margin: 5px">
    <button id="avatar">Avatar</button>
  </div>
  <div style="margin: 5px">
    <button id="cancel" style="background-color: aqua">Cancel</button>
  </div>
  <div></div>
</div>
<script>
  document.onclick = hideMenu;
  //document.oncontextmenu = rightClick;

  function hideMenu() {
    document.getElementById("contextMenu").style.display = "none";
  }

  function rightClick(e) {
    e.preventDefault();
    //bu id yi veriyor
    console.log("e", e.path[0].id);

    if (document.getElementById("contextMenu").style.display == "block")
      hideMenu();
    else {
      var menu = document.getElementById("contextMenu");

      menu.style.display = "block";
      menu.style.left = e.pageX + "px";
      menu.style.top = e.pageY + "px";
    }
  }

  document.getElementById("settings").onclick = async () => {
    console.log("settings");
    document.getElementById("datesettings").style.display = "block";
  };

  document.getElementById("apply").onclick = async () => {
    document.getElementById("datesettings").style.display = "none";
  };
  //sag click i kapatıyor
  document.body.oncontextmenu = function () {
    return false;
  };
  document.getElementById("date").onmouseup = function (e) {
    if (e.button === 2) {
      console.log("right click");
      rightClick(e);
    }
  };
  document.getElementById("date").onclick = async () => {
    const dateformat = document.getElementById("format");

    parent.postMessage(
      { pluginMessage: { type: "DateFormat", format: dateformat.value } },
      "*"
    );
  };
  document.getElementById("avatar").onclick = async () => {
    //parent.postMessage({ pluginMessage: { type: "Avatar",data:metaTags } }, "*");

    fetchMetaTags()
      .then((metaTags) => {
        parent.postMessage(
          { pluginMessage: { type: "Avatar", image: metaTags.image.data } },
          "*"
        );
      })
      .catch((err) => {
        parent.postMessage(
          {
            pluginMessage: {
              function: "fetchError",
              data: err,
            },
          },
          "*"
        );
      });
  };
  document.getElementById("namemale").onclick = () => {
    //const textbox = document.getElementById("count");
    //const count = parseInt(textbox.value, 10);
    //console.log("Count", count);
    const data = generateName("male");
    parent.postMessage(
      { pluginMessage: { type: "ChangeName"} },
      "*"
    );
  };
  document.getElementById("namefemale").onclick = () => {
    //const textbox = document.getElementById("count");
    //const count = parseInt(textbox.value, 10);
    //console.log("Count", count);
    const data = generateName("female");
    parent.postMessage(
      { pluginMessage: { type: "ChangeName", data: data } },
      "*"
    );
  };

  document.getElementById("cancel").onclick = () => {
    parent.postMessage({ pluginMessage: { type: "cancel" } }, "*");
  };

  async function fetchData(url) {
    const response = await fetch(url, {
      mode: "no-cors",
      header: {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Headers":
          "Origin, X-Requested-With, Content-Type, Accept",
      },
    });
    return response.json();
  }

  async function getData() {
    const res = await fetch(
      "https://www.randomlists.com/data/names-female.json",
      {
        mode: "no-cors",
        header: {
          "Access-Control-Allow-Origin": "*",
        },
      }
    );
    console.log("json", res);
    const json = await res.json();

    /*
      fetch("https://api.namefake.com/", {
        mode: "no-cors",
        header: {
          "Access-Control-Allow-Origin": "*",
        },
      })
        .then((response) => response.json())
        .then((data) => console.log("data", data));
  */
    //parent.postMessage({ pluginMessage: { type: "ChangeName" } }, "*");
    return "OK";
  }

  function fetchNames(nameType) {
    let names = [];

    switch (nameType) {
      case "female":
        names = ["Berthefried", "Tatiana", "Hildeburg", "Ayse", "Elif"];
        break;
      case "male":
        names = ["Bilbo", "Frodo", "Theodulph", "Ali", "Burak"];
        break;
      case "surnames":
        names = ["Baggins", "Lightfoot", "Boulderhill", "Aslan", "Yılmaz"];
        break;
    }

    return { data: names };
  }
  function generateName(gender) {
    // Fetch the names
    const firstNames = fetchNames(gender || pickRandom(["male", "female"]));
    const lastNames = fetchNames("surnames");

    // Pick a random name from each list
    const firstName = pickRandom(firstNames.data);
    const lastName = pickRandom(lastNames.data);

    // Use a template literal to format the full name
    return `${firstName} ${lastName}`;
  }
  function pickRandom(list) {
    return list[Math.floor(Math.random() * list.length)];
  }

  async function getEncodedImageFromURL(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();

      // Some websites will allow loading of images into a canvas if set to Anonymous
      img.crossOrigin = "Anonymous";

      img.onload = () => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        ctx.drawImage(img, 0, 0);
        canvas.toBlob(async (blob) => {
          let blobBuffer = await blob.arrayBuffer();
          resolve({
            img: img,
            data: new Uint8Array(blobBuffer),
          });
        });
      };
      // If an Anonymous image does not load, attempt to load it
      // cross origin using cors-anywhere
      img.onerror = () => {
        if (img.src.indexOf("cors-anywhere") === -1) {
          img.src = `https://cors-anywhere.com/${url.replace(
            /http(s)?:\/\//,
            ""
          )}`;
        } else {
          reject("Error fetching image");
        }
      };

      img.src = url;
    });
  }

  async function fetchMetaTags() {
    let metaTags = {};

    let imageData = await getEncodedImageFromURL(
      "https://images.unsplash.com/photo-1647323840635-d811e4547773?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=387&q=80"
    );

    console.log("imageData", imageData);
    metaTags.image = {
      data: imageData.data,
      url: imageData.img.src,
      width: imageData.img.naturalWidth,
      height: imageData.img.naturalHeight,
    };
    console.log("metaTags", metaTags);
    return metaTags;
  }
</script>
